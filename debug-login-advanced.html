<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Avan√ßado - Fluxo de Login</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { border-color: #4CAF50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #ff9800; background: #fffaf0; }
        .info { border-color: #2196F3; background: #f0f8ff; }
        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #ff5252; }
        .log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            white-space: pre-wrap;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .step {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }
        .step.active { border-color: #2196F3; background: #e3f2fd; }
        .step.success { border-color: #4CAF50; background: #e8f5e8; }
        .step.error { border-color: #f44336; background: #ffebee; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Avan√ßado - Fluxo de Login</h1>
        <p>Este script monitora cada etapa do processo de login para identificar onde est√° falhando.</p>

        <div class="debug-section info">
            <h3>üìã Status do Sistema</h3>
            <div id="system-status">Verificando...</div>
        </div>

        <div class="debug-section">
            <h3>üîê Teste de Login Detalhado</h3>
            <input type="email" id="debug-email" placeholder="Email de teste" value="">
            <input type="password" id="debug-password" placeholder="Senha de teste" value="">
            <button onclick="debugLogin()">üîç Debug Login Completo</button>
            <button onclick="clearLogs()">üßπ Limpar Logs</button>
            
            <h4>üìä Etapas do Processo:</h4>
            <div id="steps-container">
                <div class="step" id="step-1">1. Inicializa√ß√£o do Supabase</div>
                <div class="step" id="step-2">2. Tentativa de Login</div>
                <div class="step" id="step-3">3. Verifica√ß√£o de Resposta</div>
                <div class="step" id="step-4">4. Aguardo de Sess√£o (1s)</div>
                <div class="step" id="step-5">5. Verifica√ß√£o de Sess√£o</div>
                <div class="step" id="step-6">6. Redirecionamento</div>
                <div class="step" id="step-7">7. Verifica√ß√£o no App</div>
            </div>
            
            <div id="debug-log" class="log"></div>
        </div>

        <div class="debug-section">
            <h3>üß™ Testes Individuais</h3>
            <button onclick="testSupabaseInit()">Testar Inicializa√ß√£o</button>
            <button onclick="testGetSession()">Testar getSession()</button>
            <button onclick="testGetUser()">Testar getUser()</button>
            <button onclick="testWaitForSession()">Testar waitForSession()</button>
            <button onclick="simulateAppCheck()">Simular Verifica√ß√£o do App</button>
        </div>

        <div class="debug-section">
            <h3>üåê Teste de Redirecionamento</h3>
            <button onclick="testRedirect()">Testar Redirecionamento Manual</button>
            <button onclick="window.location.href='/app'">Ir para /app</button>
            <button onclick="window.location.href='login.html'">Ir para Login</button>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-client.js"></script>

    <script>
        let logElement = document.getElementById('debug-log');
        let statusElement = document.getElementById('system-status');
        let currentStep = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);
            
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'black';
            logElement.innerHTML += `<span style="color: ${color}">${logEntry}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function setStep(stepNumber, status = 'active') {
            // Reset all steps
            for (let i = 1; i <= 7; i++) {
                const step = document.getElementById(`step-${i}`);
                step.className = 'step';
            }
            
            // Set current step
            if (stepNumber > 0) {
                const step = document.getElementById(`step-${stepNumber}`);
                step.className = `step ${status}`;
                
                // Mark previous steps as success
                for (let i = 1; i < stepNumber; i++) {
                    const prevStep = document.getElementById(`step-${i}`);
                    if (!prevStep.className.includes('error')) {
                        prevStep.className = 'step success';
                    }
                }
            }
        }

        function clearLogs() {
            logElement.innerHTML = '';
            setStep(0);
        }

        async function checkSystemStatus() {
            try {
                log('üîç Verificando status do sistema...');
                
                // Verificar se Supabase est√° carregado
                if (typeof window.supabase === 'undefined') {
                    statusElement.innerHTML = '<span style="color: red;">‚ùå Supabase CDN n√£o carregado</span>';
                    return;
                }

                // Verificar se cliente est√° inicializado
                if (!window.fikahSupabase) {
                    statusElement.innerHTML = '<span style="color: orange;">‚è≥ Aguardando inicializa√ß√£o do cliente...</span>';
                    setTimeout(checkSystemStatus, 1000);
                    return;
                }

                // Verificar sess√£o atual
                const session = await window.fikahSupabase.supabase.auth.getSession();
                const user = await window.fikahSupabase.supabase.auth.getUser();

                let status = '<div>';
                status += '<div>‚úÖ Supabase CDN: Carregado</div>';
                status += '<div>‚úÖ Cliente Supabase: Inicializado</div>';
                status += `<div>${session.data.session ? '‚úÖ' : '‚ùå'} Sess√£o: ${session.data.session ? 'Ativa' : 'N√£o encontrada'}</div>`;
                status += `<div>${user.data.user ? '‚úÖ' : '‚ùå'} Usu√°rio: ${user.data.user ? user.data.user.email : 'N√£o autenticado'}</div>`;
                
                if (session.data.session) {
                    status += `<div>üïí Sess√£o expira em: ${new Date(session.data.session.expires_at * 1000).toLocaleString()}</div>`;
                }
                
                status += '</div>';
                statusElement.innerHTML = status;
                
                log(`Sistema: ${session.data.session ? 'Usu√°rio logado' : 'Usu√°rio n√£o logado'}`);
            } catch (error) {
                statusElement.innerHTML = `<span style="color: red;">‚ùå Erro: ${error.message}</span>`;
                log(`‚ùå Erro no sistema: ${error.message}`, 'error');
            }
        }

        async function debugLogin() {
            const email = document.getElementById('debug-email').value;
            const password = document.getElementById('debug-password').value;

            if (!email || !password) {
                log('‚ùå Por favor, preencha email e senha', 'error');
                return;
            }

            clearLogs();
            log('üöÄ INICIANDO DEBUG DE LOGIN COMPLETO');
            log(`üìß Email: ${email}`);
            log('üîí Senha: [OCULTA]');
            log('');

            try {
                // Etapa 1: Inicializa√ß√£o
                setStep(1, 'active');
                log('üìã ETAPA 1: Verificando inicializa√ß√£o do Supabase...');
                
                if (!window.fikahSupabase) {
                    setStep(1, 'error');
                    log('‚ùå Cliente Supabase n√£o inicializado!', 'error');
                    return;
                }
                
                log('‚úÖ Cliente Supabase inicializado');
                setStep(1, 'success');
                await new Promise(resolve => setTimeout(resolve, 500));

                // Etapa 2: Login
                setStep(2, 'active');
                log('üìã ETAPA 2: Tentando fazer login...');
                
                const loginResult = await window.fikahSupabase.loginUser(email, password);
                log(`üìä Resultado do login: ${JSON.stringify(loginResult, null, 2)}`);
                
                if (!loginResult.user) {
                    setStep(2, 'error');
                    log('‚ùå Login falhou - usu√°rio n√£o retornado', 'error');
                    return;
                }
                
                log(`‚úÖ Login bem-sucedido: ${loginResult.user.email}`, 'success');
                setStep(2, 'success');
                await new Promise(resolve => setTimeout(resolve, 500));

                // Etapa 3: Verifica√ß√£o de resposta
                setStep(3, 'active');
                log('üìã ETAPA 3: Verificando resposta do login...');
                
                const immediateSession = await window.fikahSupabase.supabase.auth.getSession();
                log(`üìä Sess√£o imediata: ${JSON.stringify(immediateSession.data, null, 2)}`);
                
                const immediateUser = await window.fikahSupabase.supabase.auth.getUser();
                log(`üìä Usu√°rio imediato: ${JSON.stringify(immediateUser.data, null, 2)}`);
                
                setStep(3, 'success');
                await new Promise(resolve => setTimeout(resolve, 500));

                // Etapa 4: Aguardo
                setStep(4, 'active');
                log('üìã ETAPA 4: Aguardando 1 segundo para sess√£o ser estabelecida...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                log('‚úÖ Aguardo conclu√≠do');
                setStep(4, 'success');

                // Etapa 5: Verifica√ß√£o de sess√£o
                setStep(5, 'active');
                log('üìã ETAPA 5: Verificando sess√£o ap√≥s aguardo...');
                
                const sessionAfterWait = await window.fikahSupabase.supabase.auth.getSession();
                log(`üìä Sess√£o ap√≥s aguardo: ${JSON.stringify(sessionAfterWait.data, null, 2)}`);
                
                const waitForSessionResult = await window.fikahSupabase.waitForSession(5);
                log(`üìä waitForSession resultado: ${JSON.stringify(waitForSessionResult, null, 2)}`);
                
                if (!waitForSessionResult) {
                    setStep(5, 'error');
                    log('‚ùå Sess√£o n√£o estabelecida ap√≥s aguardo', 'error');
                } else {
                    log('‚úÖ Sess√£o estabelecida com sucesso', 'success');
                    setStep(5, 'success');
                }
                await new Promise(resolve => setTimeout(resolve, 500));

                // Etapa 6: Redirecionamento
                setStep(6, 'active');
                log('üìã ETAPA 6: Simulando redirecionamento...');
                log('üîÑ Em um cen√°rio real, redirecionaria para /app agora');
                log('‚úÖ Redirecionamento seria executado');
                setStep(6, 'success');
                await new Promise(resolve => setTimeout(resolve, 500));

                // Etapa 7: Verifica√ß√£o no app
                setStep(7, 'active');
                log('üìã ETAPA 7: Simulando verifica√ß√£o no app...');
                await simulateAppCheck();
                setStep(7, 'success');

                log('');
                log('üéâ DEBUG COMPLETO! Verifique os logs acima para identificar problemas.');

            } catch (error) {
                log(`‚ùå ERRO DURANTE DEBUG: ${error.message}`, 'error');
                log(`üìä Stack trace: ${error.stack}`, 'error');
                setStep(currentStep, 'error');
            }

            // Atualizar status
            setTimeout(checkSystemStatus, 1000);
        }

        async function testSupabaseInit() {
            log('üß™ Testando inicializa√ß√£o do Supabase...');
            log(`Supabase global: ${typeof window.supabase}`);
            log(`Cliente fikah: ${typeof window.fikahSupabase}`);
            if (window.fikahSupabase) {
                log(`URL: ${window.fikahSupabase.supabase.supabaseUrl}`);
                log(`Key: ${window.fikahSupabase.supabase.supabaseKey.substring(0, 20)}...`);
            }
        }

        async function testGetSession() {
            log('üß™ Testando getSession()...');
            try {
                const session = await window.fikahSupabase.supabase.auth.getSession();
                log(`üìä getSession resultado: ${JSON.stringify(session, null, 2)}`);
            } catch (error) {
                log(`‚ùå Erro em getSession: ${error.message}`, 'error');
            }
        }

        async function testGetUser() {
            log('üß™ Testando getUser()...');
            try {
                const user = await window.fikahSupabase.supabase.auth.getUser();
                log(`üìä getUser resultado: ${JSON.stringify(user, null, 2)}`);
            } catch (error) {
                log(`‚ùå Erro em getUser: ${error.message}`, 'error');
            }
        }

        async function testWaitForSession() {
            log('üß™ Testando waitForSession()...');
            try {
                const session = await window.fikahSupabase.waitForSession(5);
                log(`üìä waitForSession resultado: ${JSON.stringify(session, null, 2)}`);
            } catch (error) {
                log(`‚ùå Erro em waitForSession: ${error.message}`, 'error');
            }
        }

        async function simulateAppCheck() {
            log('üß™ Simulando verifica√ß√£o do app (index.html)...');
            try {
                // Simular o que acontece no index.html
                log('‚è≥ Aguardando sess√£o (como no index.html)...');
                const session = await window.fikahSupabase.waitForSession(15);
                
                if (session) {
                    log('‚úÖ Sess√£o encontrada - app seria carregado', 'success');
                    const currentUser = await window.fikahSupabase.getCurrentUser();
                    log(`üë§ Usu√°rio atual: ${currentUser.user ? currentUser.user.email : 'Nenhum'}`);
                } else {
                    log('‚ùå Sess√£o n√£o encontrada - redirecionaria para login', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro na simula√ß√£o: ${error.message}`, 'error');
            }
        }

        async function testRedirect() {
            log('üß™ Testando redirecionamento manual...');
            log('üîÑ Redirecionando para /app em 3 segundos...');
            setTimeout(() => {
                window.location.href = '/app';
            }, 3000);
        }

        // Verificar status ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkSystemStatus, 1000);
        });
    </script>
</body>
</html>